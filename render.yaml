services:
  # Single Fullstack Service (Backend serves Frontend)
  - type: web
    name: eco-fullstack
    runtime: node
    region: oregon
    plan: free
    branch: main
    buildCommand: |
      echo "üßπ Step 1: Cleaning ROOT directory dependencies..."
      rm -rf node_modules
      rm -f package-lock.json
      echo "üì¶ Step 2: Installing ROOT dependencies (workspaces setup)..."
      npm install
      echo "üßπ Step 3: Cleaning BACKEND dependencies..."
      cd backend
      rm -rf node_modules
      rm -f package-lock.json
      cd ..
      echo "üì¶ Step 4: Installing BACKEND dependencies..."
      npm install --workspace backend
      echo "üßπ Step 5: Cleaning FRONTEND dependencies..."
      cd frontend
      rm -rf node_modules
      rm -f package-lock.json
      cd ..
      echo "üì¶ Step 6: Installing FRONTEND dependencies..."
      npm install --workspace frontend
      echo "üèóÔ∏è Step 7: Building FRONTEND..."
      npm run build --workspace frontend
      echo "‚úÖ Full build complete! All dependencies fresh from latest git push."
    startCommand: npm run start --workspace backend
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        sync: false
      - key: MONGODB_URI
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false
      - key: SUPERADMIN_EMAIL
        sync: false
      - key: SUPERADMIN_PASSWORD
        sync: false
    healthCheckPath: /api/health
    autoDeploy: true